<Page
    x:Class="ModernIPTVPlayer.PlayerPage"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
    xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
    
    xmlns:mpv="using:MpvWinUI"
    xmlns:Media="using:Microsoft.UI.Xaml.Media"
    xmlns:local="using:ModernIPTVPlayer"

    mc:Ignorable="d"
    Background="Black">

    <Page.Resources>
        <local:TickToTimeConverter x:Key="TickToTimeConverter"/>

        <!-- Animations for Tracks Overlay -->
        <Storyboard x:Name="ShowTracksOverlayAnim">
            <DoubleAnimation Storyboard.TargetName="TracksOverlay" Storyboard.TargetProperty="Opacity" From="0" To="1" Duration="0:0:0.2"/>
            <DoubleAnimation Storyboard.TargetName="TracksOverlayTransform" Storyboard.TargetProperty="Y" From="20" To="0" Duration="0:0:0.2">
                <DoubleAnimation.EasingFunction>
                    <ExponentialEase EasingMode="EaseOut" Exponent="4"/>
                </DoubleAnimation.EasingFunction>
            </DoubleAnimation>
        </Storyboard>
        <Storyboard x:Name="HideTracksOverlayAnim">
            <DoubleAnimation Storyboard.TargetName="TracksOverlay" Storyboard.TargetProperty="Opacity" From="1" To="0" Duration="0:0:0.15"/>
            <DoubleAnimation Storyboard.TargetName="TracksOverlayTransform" Storyboard.TargetProperty="Y" From="0" To="20" Duration="0:0:0.15"/>
        </Storyboard>

        <Storyboard x:Name="ShowInfoPillsAnim">
            <DoubleAnimation Storyboard.TargetName="InfoPillsStack" Storyboard.TargetProperty="Opacity" From="0" To="1" Duration="0:0:0.3"/>
            <DoubleAnimation Storyboard.TargetName="InfoPillsTransform" Storyboard.TargetProperty="Y" From="-20" To="0" Duration="0:0:0.3">
                 <DoubleAnimation.EasingFunction>
                    <ExponentialEase EasingMode="EaseOut" Exponent="4"/>
                </DoubleAnimation.EasingFunction>
            </DoubleAnimation>
        </Storyboard>
         <Storyboard x:Name="HideInfoPillsAnim">
            <DoubleAnimation Storyboard.TargetName="InfoPillsStack" Storyboard.TargetProperty="Opacity" From="1" To="0" Duration="0:0:0.5"/>
        </Storyboard>

        <Style x:Key="SpeedItemButtonStyle" TargetType="Button">
            <Setter Property="Background" Value="Transparent"/>
            <Setter Property="Foreground" Value="White"/>
            <Setter Property="FontSize" Value="13"/>
            <Setter Property="HorizontalAlignment" Value="Stretch"/>
            <Setter Property="HorizontalContentAlignment" Value="Center"/>
            <Setter Property="Padding" Value="0,8"/>
            <Setter Property="BorderThickness" Value="0"/>
            <Setter Property="CornerRadius" Value="6"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="Button">
                        <Border x:Name="Root" Background="{TemplateBinding Background}" CornerRadius="{TemplateBinding CornerRadius}">
                            <ContentPresenter HorizontalAlignment="{TemplateBinding HorizontalContentAlignment}" VerticalAlignment="{TemplateBinding VerticalContentAlignment}" Padding="{TemplateBinding Padding}"/>
                            <VisualStateManager.VisualStateGroups>
                                <VisualStateGroup x:Name="CommonStates">
                                    <VisualState x:Name="Normal"/>
                                    <VisualState x:Name="PointerOver"/>
                                    <VisualState x:Name="Pressed"/>
                                </VisualStateGroup>
                            </VisualStateManager.VisualStateGroups>
                        </Border>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>

        <Storyboard x:Name="ShowVolumeOverlayAnim">
            <DoubleAnimation Storyboard.TargetName="VolumeOverlay" Storyboard.TargetProperty="Opacity" From="0" To="1" Duration="0:0:0.2"/>
            <DoubleAnimation Storyboard.TargetName="VolumeOverlayTransform" Storyboard.TargetProperty="Y" From="20" To="0" Duration="0:0:0.2">
                <DoubleAnimation.EasingFunction>
                    <ExponentialEase EasingMode="EaseOut" Exponent="4"/>
                </DoubleAnimation.EasingFunction>
            </DoubleAnimation>
        </Storyboard>
        <Storyboard x:Name="HideVolumeOverlayAnim">
            <DoubleAnimation Storyboard.TargetName="VolumeOverlay" Storyboard.TargetProperty="Opacity" From="1" To="0" Duration="0:0:0.15"/>
            <DoubleAnimation Storyboard.TargetName="VolumeOverlayTransform" Storyboard.TargetProperty="Y" From="0" To="20" Duration="0:0:0.15"/>
        </Storyboard>

        <!-- Speed Overlay Animations -->
        <Storyboard x:Name="ShowSpeedOverlayAnim">
            <DoubleAnimation Storyboard.TargetName="SpeedOverlay" Storyboard.TargetProperty="Opacity" From="0" To="1" Duration="0:0:0.2"/>
            <DoubleAnimation Storyboard.TargetName="SpeedOverlayTransform" Storyboard.TargetProperty="Y" From="20" To="0" Duration="0:0:0.2">
                <DoubleAnimation.EasingFunction>
                    <ExponentialEase EasingMode="EaseOut" Exponent="4"/>
                </DoubleAnimation.EasingFunction>
            </DoubleAnimation>
        </Storyboard>
        <Storyboard x:Name="HideSpeedOverlayAnim">
            <DoubleAnimation Storyboard.TargetName="SpeedOverlay" Storyboard.TargetProperty="Opacity" From="1" To="0" Duration="0:0:0.15"/>
            <DoubleAnimation Storyboard.TargetName="SpeedOverlayTransform" Storyboard.TargetProperty="Y" From="0" To="20" Duration="0:0:0.15"/>
        </Storyboard>

        <!-- Premium Horizontal Slider Style -->
        <Style x:Key="PremiumHorizontalSliderStyle" TargetType="Slider">
            <Setter Property="Background" Value="#33FFFFFF"/>
            <Setter Property="Foreground" Value="#00BFA5"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="Slider">
                        <Grid Margin="{TemplateBinding Padding}">
                            <Grid.Resources>
                                <Style TargetType="Thumb" x:Key="SliderThumbStyle">
                                    <Setter Property="BorderThickness" Value="0"/>
                                    <Setter Property="Background" Value="#FFFFFF"/>
                                    <Setter Property="Template">
                                        <Setter.Value>
                                            <ControlTemplate TargetType="Thumb">
                                                <Grid Width="18" Height="18">
                                                    <Ellipse Width="18" Height="18" Fill="Black" Opacity="0.3" Margin="1,1,-1,-1"/>
                                                    <Ellipse Width="18" Height="18" Fill="{TemplateBinding Background}" Stroke="{TemplateBinding BorderBrush}" StrokeThickness="{TemplateBinding BorderThickness}"/>
                                                </Grid>
                                            </ControlTemplate>
                                        </Setter.Value>
                                    </Setter>
                                </Style>
                            </Grid.Resources>
                            <!-- Horizontal Template -->
                            <Grid x:Name="HorizontalTemplate" MinHeight="32" Background="Transparent">
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="Auto"/>
                                    <ColumnDefinition Width="Auto"/>
                                    <ColumnDefinition Width="*"/>
                                </Grid.ColumnDefinitions>
                                
                                <!-- Track Background (Spans all) -->
                                <Rectangle x:Name="HorizontalTrackRect" Grid.Column="0" Grid.ColumnSpan="3" Height="4" Fill="{TemplateBinding Background}" RadiusX="2" RadiusY="2" VerticalAlignment="Center"/>
                                <!-- Filled Part (Col 0) -->
                                <Rectangle x:Name="HorizontalDecreaseRect" Grid.Column="0" Height="4" Fill="{TemplateBinding Foreground}" RadiusX="2" RadiusY="2" VerticalAlignment="Center"/>
                                <!-- Thumb (Col 1) -->
                                <Thumb x:Name="HorizontalThumb" Grid.Column="1" DataContext="{TemplateBinding Value}" Style="{StaticResource SliderThumbStyle}" VerticalAlignment="Center" AutomationProperties.AccessibilityView="Raw"/>
                            </Grid>
                        </Grid>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>

        <!-- Premium Vertical Slider Style -->
        <Style x:Key="PremiumVerticalSliderStyle" TargetType="Slider">
            <Setter Property="Background" Value="#33FFFFFF"/>
            <Setter Property="Foreground" Value="#00BFA5"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="Slider">
                        <Grid Margin="{TemplateBinding Padding}">
                            <Grid.Resources>
                                <Style TargetType="Thumb" x:Key="SliderThumbStyle">
                                    <Setter Property="BorderThickness" Value="0"/>
                                    <Setter Property="Background" Value="#FFFFFF"/>
                                    <Setter Property="Template">
                                        <Setter.Value>
                                            <ControlTemplate TargetType="Thumb">
                                                <Grid Width="18" Height="18">
                                                    <Ellipse Width="18" Height="18" Fill="Black" Opacity="0.3" Margin="1,1,-1,-1"/>
                                                    <Ellipse Width="18" Height="18" Fill="{TemplateBinding Background}" Stroke="{TemplateBinding BorderBrush}" StrokeThickness="{TemplateBinding BorderThickness}"/>
                                                </Grid>
                                            </ControlTemplate>
                                        </Setter.Value>
                                    </Setter>
                                </Style>
                            </Grid.Resources>
                            <!-- Vertical Template -->
                            <Grid x:Name="VerticalTemplate" MinWidth="32">
                                <Grid.RowDefinitions>
                                    <RowDefinition Height="*"/>
                                    <RowDefinition Height="Auto"/>
                                    <RowDefinition Height="Auto"/>
                                </Grid.RowDefinitions>
                                
                                <!-- Track Background (Spans all) -->
                                <Rectangle x:Name="VerticalTrackRect" Grid.Row="0" Grid.RowSpan="3" Width="4" Fill="{TemplateBinding Background}" RadiusX="2" RadiusY="2" HorizontalAlignment="Center"/>
                                <!-- Filled Part (Row 2 - Bottom) -->
                                <Rectangle x:Name="VerticalDecreaseRect" Grid.Row="2" Width="4" Fill="{TemplateBinding Foreground}" RadiusX="2" RadiusY="2" HorizontalAlignment="Center" VerticalAlignment="Bottom"/>
                                <!-- Thumb (Row 1) -->
                                <Thumb x:Name="VerticalThumb" Grid.Row="1" DataContext="{TemplateBinding Value}" Style="{StaticResource SliderThumbStyle}" HorizontalAlignment="Center" AutomationProperties.AccessibilityView="Raw"/>
                            </Grid>
                        </Grid>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>
    </Page.Resources>

    <Grid x:Name="MainGrid" DoubleTapped="Page_DoubleTapped"
          PointerPressed="MainGrid_PointerPressed"
          PointerMoved="MainGrid_PointerMoved"
          PointerReleased="MainGrid_PointerReleased"
          PointerExited="MainGrid_PointerExited"
          PointerWheelChanged="MainGrid_PointerWheelChanged"
          Background="Transparent">
        
        <!-- 1. Video Layer -->
        <MediaPlayerElement x:Name="MediaFoundationPlayer"
                        Visibility="Collapsed"
                        AutoPlay="True"
                        AreTransportControlsEnabled="False"
                        HorizontalAlignment="Stretch"
                        VerticalAlignment="Stretch"
                        IsHitTestVisible="False"/>

        <!-- Safety Blackout Layer - Prevents Desktop Flicker during MPV Resize -->
        <Grid Background="Black" HorizontalAlignment="Stretch" VerticalAlignment="Stretch"/>

        <Grid x:Name="PlayerContainer" 
              HorizontalAlignment="Stretch" 
              VerticalAlignment="Stretch"
              Background="Black"/>

        <!-- 2. Brightness Overlay (Simulated Dimming) -->
        <Rectangle x:Name="BrightnessOverlay"
                   Fill="Black"
                   Opacity="0"
                   IsHitTestVisible="False"
                   HorizontalAlignment="Stretch"
                   VerticalAlignment="Stretch"/>

        <!-- 3. OSD Overlay (Center Notification) -->
        <Border x:Name="OsdOverlay"
                Visibility="Collapsed"
                HorizontalAlignment="Center"
                VerticalAlignment="Center"
                Background="#CC000000"
                Padding="24,12"
                CornerRadius="8"
                IsHitTestVisible="False">
            <TextBlock x:Name="OsdText" 
                       Text="Notification" 
                       FontSize="24" 
                       FontWeight="SemiBold"
                       Foreground="White"/>
        </Border>

        <!-- 4. Stats Overlay (Top Left, Hidden by default) -->
        <Border x:Name="StatsOverlay"
                Visibility="Collapsed"
                HorizontalAlignment="Left"
                VerticalAlignment="Top"
                Margin="20,80,0,0"
                Padding="16"
                CornerRadius="8"
                Background="#AA000000"
                IsHitTestVisible="False">
            <StackPanel Spacing="6">
                <TextBlock Text="Yayın Bilgileri" FontWeight="Bold" Foreground="White" Margin="0,0,0,4" FontSize="14"/>
                
                <!-- Video Group -->
                <StackPanel Orientation="Horizontal" Spacing="8">
                    <TextBlock Text="Çözünürlük:" Foreground="#AAAAAA" Width="135"/>
                    <TextBlock x:Name="TxtResolution" Text="-" Foreground="White" FontWeight="SemiBold"/>
                </StackPanel>

                <StackPanel Orientation="Horizontal" Spacing="8">
                    <TextBlock Text="FPS / Monitor:" Foreground="#AAAAAA" Width="135"/>
                    <TextBlock x:Name="TxtFps" Text="-" Foreground="White" FontWeight="SemiBold"/>
                </StackPanel>

                <StackPanel Orientation="Horizontal" Spacing="8">
                    <TextBlock Text="Video Codec:" Foreground="#AAAAAA" Width="135"/>
                    <TextBlock x:Name="TxtCodec" Text="-" Foreground="White" FontWeight="SemiBold"/>
                </StackPanel>

                <StackPanel Orientation="Horizontal" Spacing="8">
                    <TextBlock Text="Audio Codec:" Foreground="#AAAAAA" Width="135"/>
                    <TextBlock x:Name="TxtAudioCodec" Text="-" Foreground="White" FontWeight="SemiBold"/>
                </StackPanel>

                <StackPanel Orientation="Horizontal" Spacing="8">
                    <TextBlock Text="Colorspace:" Foreground="#AAAAAA" Width="135"/>
                    <TextBlock x:Name="TxtColorspace" Text="-" Foreground="White" FontWeight="SemiBold"/>
                </StackPanel>

                <StackPanel Orientation="Horizontal" Spacing="8">
                    <TextBlock Text="HDR / Tone:" Foreground="#AAAAAA" Width="135"/>
                    <TextBlock x:Name="TxtHdr" Text="-" Foreground="White" FontWeight="SemiBold"/>
                </StackPanel>

                <!-- Connection Group -->
                <StackPanel Orientation="Horizontal" Spacing="8" Margin="0,6,0,0">
                    <TextBlock Text="Download Speed:" Foreground="#AAAAAA" Width="135"/>
                    <TextBlock x:Name="TxtSpeed" Text="-" Foreground="White" FontWeight="SemiBold"/>
                </StackPanel>

                <StackPanel Orientation="Horizontal" Spacing="8">
                    <TextBlock Text="Bitrate:" Foreground="#AAAAAA" Width="135"/>
                    <TextBlock x:Name="TxtBitrate" Text="-" Foreground="White" FontWeight="SemiBold"/>
                </StackPanel>

                <StackPanel Orientation="Horizontal" Spacing="8">
                    <TextBlock Text="Buffer:" Foreground="#AAAAAA" Width="135"/>
                    <TextBlock x:Name="TxtBuffer" Text="-" Foreground="White" FontWeight="SemiBold"/>
                </StackPanel>

                <!-- Performance Group -->
                <StackPanel Orientation="Horizontal" Spacing="8" Margin="0,6,0,0">
                    <TextBlock Text="Hardware:" Foreground="#AAAAAA" Width="135"/>
                    <TextBlock x:Name="TxtHardware" Text="-" Foreground="White" FontWeight="SemiBold"/>
                </StackPanel>

                <StackPanel Orientation="Horizontal" Spacing="8">
                    <TextBlock Text="A/V Sync:" Foreground="#AAAAAA" Width="135"/>
                    <TextBlock x:Name="TxtAvSync" Text="-" Foreground="White" FontWeight="SemiBold"/>
                </StackPanel>

                <StackPanel Orientation="Horizontal" Spacing="8">
                    <TextBlock Text="Dropped:" Foreground="#AAAAAA" Width="135"/>
                    <TextBlock x:Name="TxtDroppedDecoder" Text="-" Foreground="White" FontWeight="SemiBold"/>
                </StackPanel>
            </StackPanel>
        </Border>

        <!-- 5. Info Pills (Top Left, to the right of BackButton, Transient) -->
        <StackPanel x:Name="InfoPillsStack"
                    Orientation="Horizontal"
                    Spacing="8"
                    HorizontalAlignment="Left"
                    VerticalAlignment="Top"
                    Margin="80,32,0,0"
                    Visibility="Collapsed"
                    IsHitTestVisible="False">
            <StackPanel.RenderTransform>
                <TranslateTransform x:Name="InfoPillsTransform"/>
            </StackPanel.RenderTransform>
            <StackPanel.Resources>
                 <Style TargetType="Border">
                     <Setter Property="Background" Value="#99000000"/>
                     <Setter Property="CornerRadius" Value="14"/>
                     <Setter Property="Padding" Value="12,4"/>
                     <Setter Property="Height" Value="28"/>
                 </Style>
                 <Style TargetType="TextBlock">
                     <Setter Property="Foreground" Value="White"/>
                     <Setter Property="FontSize" Value="12"/>
                     <Setter Property="FontWeight" Value="SemiBold"/>
                     <Setter Property="VerticalAlignment" Value="Center"/>
                 </Style>
            </StackPanel.Resources>
            
            <Border>
                <TextBlock x:Name="PillResolution" Text="1080p"/>
            </Border>
            <Border>
                <TextBlock x:Name="PillFps" Text="60 fps"/>
            </Border>
            <Border>
                <TextBlock x:Name="PillCodec" Text="h264"/>
            </Border>
        </StackPanel>

        <!-- 5. Top Controls -->
        <Button x:Name="BackButton"
                Click="BackButton_Click"
                HorizontalAlignment="Left"
                VerticalAlignment="Top"
                Margin="20"
                Width="48" Height="48" CornerRadius="24"
                Background="#99000000" Foreground="White"
                BorderThickness="0"
                ToolTipService.ToolTip="Geri Dön">
            <FontIcon Glyph="&#xE72B;" FontSize="20"/>
        </Button>

        <!-- Video Title (Top Center) -->
        <TextBlock x:Name="VideoTitleText"
                   Text=""
                   HorizontalAlignment="Center"
                   VerticalAlignment="Top"
                   Margin="0,32,0,0"
                   FontSize="20"
                   FontWeight="SemiBold"
                   Foreground="White"
                   IsHitTestVisible="False"
                   TextTrimming="CharacterEllipsis"
                   MaxWidth="600">
        </TextBlock>


        <Button x:Name="FullScreenButton"
                Click="FullScreenButton_Click"
                HorizontalAlignment="Right"
                VerticalAlignment="Top"
                Margin="20,48,20,0"
                Width="48" Height="48" CornerRadius="24"
                Background="#99000000" Foreground="White"
                BorderThickness="0"
                ToolTipService.ToolTip="Tam Ekran">
            <FontIcon x:Name="FullScreenIcon" Glyph="&#xE1D9;" FontSize="20"/>
        </Button>

        <!-- 6. Bottom Control Bar -->
        <Border x:Name="ControlsBorder"
                VerticalAlignment="Bottom"
                HorizontalAlignment="Stretch"
                Height="110"
                Padding="24,0"
                DoubleTapped="ControlBar_DoubleTapped">
            <Border.Background>
                <LinearGradientBrush StartPoint="0,0" EndPoint="0,1">
                    <GradientStop Color="#00000000" Offset="0"/>
                    <GradientStop Color="#CC000000" Offset="1"/>
                </LinearGradientBrush>
            </Border.Background>

            <Grid VerticalAlignment="Bottom" Margin="0,0,0,24">
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="Auto"/> <!-- Left: Play/Pause -->
                    <ColumnDefinition Width="*"/>    <!-- Center: Timeline -->
                    <ColumnDefinition Width="Auto"/> <!-- Right: Options -->
                </Grid.ColumnDefinitions>

                <!-- Center: Seekbar & Time -->
                <Grid Grid.Column="1" Margin="24,0" VerticalAlignment="Center">
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="Auto"/>
                    </Grid.RowDefinitions>

                    <!-- Time & Live Status -->
                    <Grid Grid.Row="0" Margin="4,0,4,4">
                        <TextBlock x:Name="TimeTextBlock" 
                                   Text="00:00 / 00:00" 
                                   Foreground="#DDFFFFFF" 
                                   HorizontalAlignment="Left"
                                   FontSize="13"
                                   FontWeight="Medium"/>
                        
                        <Button x:Name="LiveButton"
                                Click="LiveButton_Click"
                                Visibility="Collapsed"
                                HorizontalAlignment="Right"
                                Padding="4,2"
                                Height="24"
                                CornerRadius="4"
                                Background="Transparent"
                                BorderThickness="0">
                             <StackPanel Orientation="Horizontal" Spacing="6">
                                 <Ellipse x:Name="LiveIndicator" Width="8" Height="8" Fill="#FF0000"/>
                                 <TextBlock x:Name="LiveText" Text="CANLI" Foreground="White" FontWeight="Bold" FontSize="12"/>
                             </StackPanel>
                        </Button>
                    </Grid>

                    <!-- Seek Slider -->
                    <Slider x:Name="SeekSlider"
                            Grid.Row="1"
                            VerticalAlignment="Center"
                            IsThumbToolTipEnabled="True"
                            ThumbToolTipValueConverter="{StaticResource TickToTimeConverter}"
                            IsEnabled="True"
                            Style="{StaticResource PremiumHorizontalSliderStyle}"
                            Tapped="SeekSlider_Tapped"
                            Visibility="Visible"/>
                </Grid>

                <!-- Left: Controls -->
                <StackPanel Orientation="Horizontal" Spacing="16" Grid.Column="0" 
                            PointerPressed="InteractiveControl_PointerPressed"
                            PointerMoved="InteractiveControl_PointerMoved">
                    <Button x:Name="PlayPauseButton"
                            Click="PlayPauseButton_Click"
                            Width="56" Height="56" CornerRadius="28"
                            Background="White" Foreground="Black"
                            BorderThickness="0"
                            ToolTipService.ToolTip="Oynat/Duraklat">
                        <FontIcon x:Name="PlayPauseIcon" Glyph="&#xE769;" FontSize="24"/>
                    </Button>

                    <StackPanel Orientation="Horizontal" Spacing="8" VerticalAlignment="Center">
                        <Button x:Name="RewindButton"
                                Click="RewindButton_Click"
                                Width="40" Height="40" CornerRadius="20"
                                Background="#99000000" Foreground="White"
                                BorderThickness="0"
                                ToolTipService.ToolTip="10 sn Geri">
                            <FontIcon Glyph="&#xE76B;" FontSize="16"/>
                        </Button>
                        <Button x:Name="FastForwardButton"
                                Click="FastForwardButton_Click"
                                Width="40" Height="40" CornerRadius="20"
                                Background="#99000000" Foreground="White"
                                BorderThickness="0"
                                ToolTipService.ToolTip="30 sn İleri">
                            <FontIcon Glyph="&#xE76C;" FontSize="16"/>
                        </Button>
                    </StackPanel>
                </StackPanel>

                <!-- Right: Options -->
                <StackPanel Orientation="Horizontal" Spacing="12" Grid.Column="2" 
                            PointerPressed="InteractiveControl_PointerPressed"
                            PointerMoved="InteractiveControl_PointerMoved">
                    
                    <!-- Volume Control Container -->
                    <Grid Width="48">
                        <Button x:Name="VolumeButton"
                                Click="VolumeButton_Click"
                                Width="48" Height="48" CornerRadius="24"
                                Background="#99000000" Foreground="White"
                                BorderThickness="0"
                                ToolTipService.ToolTip="Ses Seviyesi">
                            <FontIcon x:Name="VolumeIcon" Glyph="&#xE995;" FontSize="20"/>
                        </Button>

                        <!-- Volume Overlay (Popup Canvas) - Defined AFTER button to be consistently on top if overlap occurs, but we also moved it up -->
                        <Canvas>
                            <Grid x:Name="VolumeOverlay"
                                  PointerPressed="InteractiveControl_PointerPressed"
                                  PointerMoved="InteractiveControl_PointerMoved"
                                  Visibility="Collapsed"
                                  Canvas.Left="-6" 
                                  Canvas.Top="-200"
                                  Width="60" Height="190"
                                  Canvas.ZIndex="999">
                                <Grid.RenderTransform>
                                    <TranslateTransform x:Name="VolumeOverlayTransform"/>
                                </Grid.RenderTransform>
                                
                                <!-- Integrated Pill -->
                                <Border Background="#DD101010" CornerRadius="30" BorderThickness="1" BorderBrush="#33FFFFFF">
                                    <Grid>
                                        <Grid.RowDefinitions>
                                            <RowDefinition Height="*"/> <!-- Slider Area -->
                                            <RowDefinition Height="Auto"/> <!-- Mute Button -->
                                        </Grid.RowDefinitions>
                                        
                                        <!-- Slider -->
                                        <Slider x:Name="VolumeSlider"
                                                Grid.Row="0"
                                                Orientation="Vertical"
                                                HorizontalAlignment="Center"
                                                VerticalAlignment="Center"
                                                Margin="0,10,0,0"
                                                Height="120"
                                                Minimum="0" Maximum="100" Value="100"
                                                ValueChanged="VolumeSlider_ValueChanged"
                                                PointerPressed="InteractiveControl_PointerPressed"
                                                PointerMoved="InteractiveControl_PointerMoved"
                                                IsThumbToolTipEnabled="False"
                                                Style="{StaticResource PremiumVerticalSliderStyle}"/>
                                             
                                        <!-- Mute Button -->
                                        <Button x:Name="ActualMuteButton" Grid.Row="1" Click="MuteButton_Click"
                                                Width="40" Height="40" CornerRadius="20" Margin="0,4,0,4"
                                                HorizontalAlignment="Center" Background="Transparent" Padding="0" BorderThickness="0">
                                                <FontIcon x:Name="MuteIcon" Glyph="&#xE74F;" FontSize="16"/>
                                        </Button>
                                    </Grid>
                                </Border>
                            </Grid>
                        </Canvas>
                    </Grid>

                    <Button x:Name="MultiViewButton"
                            Click="MultiViewButton_Click"
                            Width="48" Height="48" CornerRadius="24"
                            Background="#99000000" Foreground="White"
                            BorderThickness="0"
                            ToolTipService.ToolTip="Çoklu Ekran">
                        <FontIcon Glyph="&#xE740;" FontSize="20"/>
                    </Button>

                    <!-- Speed Button Wrapper -->
                    <Grid Width="48">
                         <!-- Speed Overlay -->
                         <Canvas>
                            <Grid x:Name="SpeedOverlay" 
                                  Visibility="Collapsed" 
                                  Canvas.Left="-16" 
                                  Canvas.Top="-160"
                                  Width="80" Height="150"
                                  Canvas.ZIndex="1000"
                                  Background="Transparent">
                                <Grid.RenderTransform>
                                    <TranslateTransform x:Name="SpeedOverlayTransform"/>
                                </Grid.RenderTransform>

                                <Border Background="#EE101010" CornerRadius="12" BorderThickness="1" BorderBrush="#33FFFFFF">
                                    <Grid>
                                        <!-- Selection Highlight Bar -->
                                        <Border Height="36" VerticalAlignment="Center" Background="#22FFFFFF" Margin="4,0" CornerRadius="6"/>
                                        
                                        <!-- Scrollable List -->
                                        <ScrollViewer x:Name="SpeedScrollViewer" 
                                                      VerticalScrollBarVisibility="Hidden" 
                                                      VerticalScrollMode="Enabled" 
                                                      HorizontalScrollMode="Disabled"
                                                      Background="Transparent"
                                                      ViewChanged="SpeedScrollViewer_ViewChanged">
                                            <StackPanel x:Name="SpeedListStack" 
                                                        Padding="0,57" Spacing="0" 
                                                        HorizontalAlignment="Stretch"
                                                        Loaded="SpeedListStack_Loaded">
                                                <Button Content="2.0x" Click="SpeedMenu_Click" Tag="2.0" Height="36" Style="{StaticResource SpeedItemButtonStyle}" Margin="0"/>
                                                <Button Content="1.5x" Click="SpeedMenu_Click" Tag="1.5" Height="36" Style="{StaticResource SpeedItemButtonStyle}" Margin="0"/>
                                                <Button Content="1.25x" Click="SpeedMenu_Click" Tag="1.25" Height="36" Style="{StaticResource SpeedItemButtonStyle}" Margin="0"/>
                                                <Button Content="1.0x" Click="SpeedMenu_Click" Tag="1.0" Height="36" Style="{StaticResource SpeedItemButtonStyle}" FontWeight="Bold" Margin="0"/>
                                                <Button Content="0.75x" Click="SpeedMenu_Click" Tag="0.75" Height="36" Style="{StaticResource SpeedItemButtonStyle}" Margin="0"/>
                                                <Button Content="0.5x" Click="SpeedMenu_Click" Tag="0.5" Height="36" Style="{StaticResource SpeedItemButtonStyle}" Margin="0"/>
                                            </StackPanel>
                                        </ScrollViewer>
                                    </Grid>
                                </Border>
                            </Grid>
                        </Canvas>

                        <Button x:Name="SpeedButton" 
                                Click="SpeedButton_Click"
                                Width="48" Height="48" CornerRadius="24"
                                Background="#99000000" Foreground="White"
                                BorderThickness="0"
                                ToolTipService.ToolTip="Hız">
                            <FontIcon Glyph="&#xEC58;" FontSize="20"/>
                        </Button>
                    </Grid>


                    <!-- Unified Tracks Button Wrapper -->
                    <Grid Width="48">
                         <!-- Tracks Overlay (Popup aligned to button via Canvas) -->
                         <Canvas>
                            <Grid x:Name="TracksOverlay" 
                                  PointerPressed="InteractiveControl_PointerPressed"
                                  PointerMoved="InteractiveControl_PointerMoved"
                                  Visibility="Collapsed" 
                                  Canvas.Left="-250"
                                  Canvas.Top="-360"
                                  Width="420" Height="350"
                                  Canvas.ZIndex="1000">
                                <Grid.RenderTransform>
                                    <TranslateTransform x:Name="TracksOverlayTransform"/>
                                </Grid.RenderTransform>

                                <Border Background="#DD101010" CornerRadius="16" BorderThickness="1" BorderBrush="#33FFFFFF">
                                    <Grid>
                                        <Grid.RowDefinitions>
                                            <RowDefinition Height="Auto"/> <!-- Header -->
                                            <RowDefinition Height="*"/>    <!-- Content -->
                                        </Grid.RowDefinitions>

                                        <!-- Header -->
                                        <Grid Grid.Row="0" Padding="16,12" Background="#22FFFFFF" Height="48">
                                             <TextBlock Text="Parça Seçimi" VerticalAlignment="Center" HorizontalAlignment="Left" FontWeight="Bold" Foreground="White" FontSize="14"/>
                                             <Button x:Name="CloseTracksButton" Click="CloseTracksButton_Click" 
                                                    HorizontalAlignment="Right" Background="Transparent" Foreground="White" Width="36" Height="36" Padding="0" BorderThickness="0">
                                                <FontIcon Glyph="&#xE711;" FontSize="14"/>
                                            </Button>
                                        </Grid>

                                        <!-- 2-Column Content -->
                                        <Grid Grid.Row="1" Padding="0,8">
                                            <Grid.ColumnDefinitions>
                                                <ColumnDefinition Width="*"/>
                                                <ColumnDefinition Width="1"/> <!-- Divider -->
                                                <ColumnDefinition Width="*"/>
                                            </Grid.ColumnDefinitions>

                                            <!-- AUDIO (Left) -->
                                            <Grid Grid.Column="0">
                                                <Grid.RowDefinitions>
                                                    <RowDefinition Height="Auto"/>
                                                    <RowDefinition Height="*"/>
                                                </Grid.RowDefinitions>
                                                <TextBlock Text="SES" Foreground="#AAAAAA" FontSize="11" FontWeight="Bold" Margin="16,4,16,8" HorizontalAlignment="Center"/>
                                                <ListView Grid.Row="1" x:Name="AudioListView" SelectionMode="Single" SelectionChanged="AudioListView_SelectionChanged"
                                                          ScrollViewer.VerticalScrollMode="Auto" ScrollViewer.VerticalScrollBarVisibility="Hidden" Padding="8,0">
                                                    <ListView.ItemTemplate>
                                                        <DataTemplate>
                                                            <Border CornerRadius="6" Padding="8,8" Background="Transparent">
                                                                <TextBlock Text="{Binding Text}" Foreground="White" FontSize="13" TextTrimming="CharacterEllipsis"/>
                                                            </Border>
                                                        </DataTemplate>
                                                    </ListView.ItemTemplate>
                                                </ListView>
                                            </Grid>

                                            <!-- Divider -->
                                            <Border Grid.Column="1" Background="#33FFFFFF" VerticalAlignment="Stretch" Margin="0,8"/>

                                            <!-- SUBTITLES (Right) -->
                                            <Grid Grid.Column="2">
                                                <Grid.RowDefinitions>
                                                    <RowDefinition Height="Auto"/>
                                                    <RowDefinition Height="*"/>
                                                </Grid.RowDefinitions>
                                                <TextBlock Text="ALTYAZI" Foreground="#AAAAAA" FontSize="11" FontWeight="Bold" Margin="16,4,16,8" HorizontalAlignment="Center"/>
                                                <ListView Grid.Row="1" x:Name="SubtitleListView" SelectionMode="Single" SelectionChanged="SubtitleListView_SelectionChanged"
                                                          ScrollViewer.VerticalScrollMode="Auto" ScrollViewer.VerticalScrollBarVisibility="Hidden" Padding="8,0">
                                                    <ListView.ItemTemplate>
                                                        <DataTemplate>
                                                            <Border CornerRadius="6" Padding="8,8" Background="Transparent">
                                                                <TextBlock Text="{Binding Text}" Foreground="White" FontSize="13" TextTrimming="CharacterEllipsis"/>
                                                            </Border>
                                                        </DataTemplate>
                                                    </ListView.ItemTemplate>
                                                </ListView>
                                            </Grid>
                                        </Grid>
                                    </Grid>
                                </Border>
                            </Grid>
                        </Canvas>

                        <Button x:Name="TracksButton" 
                                Click="TracksButton_Click"
                                Width="48" Height="48" CornerRadius="24"
                                Background="#99000000" Foreground="White"
                                BorderThickness="0"
                                ToolTipService.ToolTip="Ses ve Altyazı Ayarları">
                            <FontIcon Glyph="&#xE7F4;" FontSize="20"/>
                        </Button>
                    </Grid>

                    <!-- Aspect Ratio -->
                    <Button x:Name="AspectRatioButton" 
                            Click="AspectRatioButton_Click"
                            Width="48" Height="48" CornerRadius="24"
                            Background="#99000000" Foreground="White"
                            BorderThickness="0"
                            ToolTipService.ToolTip="Görüntü Oranı">
                        <FontIcon Glyph="&#xE799;" FontSize="20"/>
                    </Button>

                    <!-- Info -->
                    <Button x:Name="InfoButton" 
                            Click="InfoButton_Click"
                            Width="48" Height="48" CornerRadius="24"
                            Background="#99000000" Foreground="White"
                            BorderThickness="0"
                            ToolTipService.ToolTip="Yayın Bilgisi">
                        <FontIcon Glyph="&#xE946;" FontSize="20"/>
                    </Button>
                </StackPanel>
            </Grid>
        </Border>
    </Grid>
</Page>